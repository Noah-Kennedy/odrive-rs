language: rust

matrix:
  allow_failures:
    - rust: nightly
  fast_finish: true

jobs:
  include:
    - stage: Tests
      addons:
        apt:
          packages:
            - libudev-dev
      arch:
        - amd64
        - arm64
      rust:
        - stable
        - beta
        - nightly
      script: cargo test

    - stage: Coverage
      addons:
        apt:
          packages:
            - libssl-dev
            - libudev-dev
      arch: amd64
      rust: stable
      cache: cargo
      script:
        - cargo install cargo-tarpaulin || true
        - cargo tarpaulin --out Xml
        - bash <(curl -s https://codecov.io/bash)